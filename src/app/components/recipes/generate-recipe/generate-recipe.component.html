<p-toast></p-toast>

<div
  class="max-w-4xl mx-auto min-h-[calc(100vh-6rem)] flex flex-col justify-center"
>
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800">Generar Nueva Receta</h2>
    <p class="text-gray-600 mt-2">
      Sube una foto o toma una captura de tus ingredientes.
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Left Column: Upload/Camera Area -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
      <canvas #canvas class="hidden"></canvas>

      <div
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        class="relative border-2 border-dashed rounded-xl p-2 flex flex-col items-center justify-center transition-all duration-200 min-h-[300px] overflow-hidden bg-gray-50"
        [ngClass]="{
          'border-orange-400 bg-orange-50': isDragging,
          'border-gray-300': !isDragging
        }"
      >
        <!-- 1. DEFAULT VIEW -->
        <ng-container *ngIf="!imagePreview && !isCameraOpen">
          <div
            class="flex flex-col items-center justify-center p-6 w-full h-full"
          >
            <div
              class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-orange-500"
            >
              <i class="pi pi-images text-3xl"></i>
            </div>
            <p class="text-gray-700 font-medium text-center mb-1">
              Arrastra tu imagen aquí
            </p>
            <p class="text-gray-400 text-sm mb-6 text-center">
              Formato JPG, PNG o WebP
            </p>

            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
              <input
                type="file"
                #fileInput
                class="hidden"
                accept="image/*"
                (change)="onFileSelected($event)"
              />
              <button
                (click)="fileInput.click()"
                class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors shadow-sm flex items-center justify-center gap-2"
              >
                <i class="pi pi-folder-open"></i> Archivos
              </button>

              <button
                (click)="startCamera()"
                class="px-6 py-2 bg-orange-100 border border-orange-200 text-orange-700 rounded-lg hover:bg-orange-200 font-medium transition-colors shadow-sm flex items-center justify-center gap-2"
              >
                <i class="pi pi-camera"></i> Cámara
              </button>
            </div>
          </div>
        </ng-container>

        <!-- 2. CAMERA VIEW -->
        <div
          *ngIf="isCameraOpen"
          class="absolute inset-0 bg-black flex flex-col items-center justify-center w-full h-full"
        >
          <video
            #video
            class="w-full h-full object-cover"
            autoplay
            playsinline
            muted
          ></video>

          <!-- CONTROLS OVERLAY -->
          <div
            *ngIf="!isProcessingCapture"
            class="absolute bottom-4 flex gap-4 animate-fade-in"
          >
            <button
              (click)="stopCamera()"
              class="w-12 h-12 rounded-full bg-gray-600/80 text-white flex items-center justify-center hover:bg-gray-700 transition-colors"
              title="Cancelar"
            >
              <i class="pi pi-times"></i>
            </button>

            <button
              (click)="capturePhoto()"
              class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-red-500 hover:bg-red-600 transition-colors shadow-lg active:scale-95 transform duration-100"
              title="Capturar foto"
            >
              <div class="w-12 h-12 bg-white/20 rounded-full"></div>
            </button>
          </div>

          <!-- PROCESSING LOADING OVERLAY (Added this part) -->
          <div
            *ngIf="isProcessingCapture"
            class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center z-50 backdrop-blur-sm"
          >
            <i class="pi pi-spin pi-spinner text-white text-4xl mb-3"></i>
            <span class="text-white font-medium">Procesando imagen...</span>
          </div>
        </div>

        <!-- 3. PREVIEW VIEW -->
        <div
          *ngIf="imagePreview"
          class="w-full h-full relative group flex items-center justify-center bg-gray-100 animate-fade-in"
        >
          <img
            [src]="imagePreview"
            class="max-h-full max-w-full object-contain shadow-sm"
          />

          <button
            (click)="removeImage()"
            class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600 transition-colors z-10"
          >
            <i class="pi pi-times"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Right Column: Options -->
    <div class="flex flex-col gap-6">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4">
          Opciones de Generación
        </h3>

        <div
          class="flex items-center p-4 bg-orange-50 rounded-xl border border-orange-100"
        >
          <input
            type="checkbox"
            id="suggest"
            [(ngModel)]="suggestIngredients"
            class="w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500"
          />
          <label for="suggest" class="ml-3 cursor-pointer select-none">
            <span class="block text-gray-800 font-medium"
              >Sugerir Ingredientes Extra</span
            >
            <span class="block text-sm text-gray-500"
              >La IA intentará deducir qué más podrías añadir.</span
            >
          </label>
        </div>
      </div>

      <button
        (click)="generate()"
        [disabled]="!selectedFile || isLoading || isCameraOpen"
        class="w-full py-4 px-6 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-xl shadow-lg font-bold text-lg hover:from-orange-600 hover:to-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform active:scale-95 flex items-center justify-center gap-2"
      >
        <i *ngIf="isLoading" class="pi pi-spin pi-spinner"></i>
        <i *ngIf="!isLoading" class="pi pi-sparkles"></i>
        {{ isLoading ? "Generando Recetas..." : "Generar Recetas" }}
      </button>

      <div class="text-center text-xs text-gray-400">
        La generación puede tardar unos segundos.
      </div>
    </div>
  </div>
</div>
